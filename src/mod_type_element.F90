#include "config.h"

! #define DEBUG

!! @author Paul Baumeister
!! @version 3.0
!!
!! type element contains the standart weight
!! and default electronic configuration of a species
module type_element
  use configuration, only: o
implicit none
  private ! default for this module namespace

  character(len=*), parameter, private :: sym = 'tELEMENT' !! module symbol

  public :: element
  public :: init
  public :: atomicnumber_by_symbol
  public :: customize_element
  public :: neutral_level_energy
  public :: symbol
  public :: element_name
  public :: element_by_symbol
  public :: show_electronic_configuration
  public :: to_string
#ifdef EXTENDED
  public :: test
#endif

  interface to_string
    module procedure element2string
  endinterface

  interface symbol
    module procedure symbol_i, symbol_e
  endinterface

  interface element_by_symbol
    module procedure element_by_symbol_i, element_by_symbol_s
  endinterface

#ifdef DEBUG
  iounit_t, parameter :: u = 6 ! debug out unit, 0: no output
#define cDBG  
#else
  iounit_t, parameter :: u = 0 ! debug out unit, 0: no output
#define cDBG !DBG
#endif


  integer, parameter :: ECONF_LEN = 64 !! length of the electronic configuration string
  integer, parameter :: CLASS_LEN = 4 !! length of the classification string

  !=======================================================================================
  !! hold all information of the periodic system of elements
  type :: element     !! setup data for radial all-electron calculation
    real                      :: Z      !! core charge, number of protons in the core
    character(len=2)          :: sym    !! chemical symbol
    character(len=16)         :: name   !! full name of the element
    real                      :: eneg   !! electronegativity
    character(len=CLASS_LEN)  :: class  !! material class
    real                      :: decay  !! decay constant atomic density ==> start guess
    real                      :: weight_u !! core weight in u [Dalton]
    ! In Dalton, the weight of C12 = 12.0 u. The weight
    ! of Carbon, however is 12.010700 because of naturally occuring C14
    character(len=ECONF_LEN)  :: config !! electronic configuration string
  endtype ! element
  !=======================================================================================


  real, parameter :: DEF_RCUT = 2.0 !! default value for cutoff radius
  real, parameter :: NGEN = 0.0 !! electronegativity of noble gases
  real, parameter :: UKEN = 0.0 !! unknown electronegativity value

  ! classifications
  character(len=CLASS_LEN), parameter :: R1 = '1stR' !! first row
  character(len=CLASS_LEN), parameter :: NG = 'NGas' !! noble gas
  character(len=CLASS_LEN), parameter :: D3 = 'TM3d' !! 3d transition metal
  character(len=CLASS_LEN), parameter :: D4 = 'TM4d' !! 4d transition metal
  character(len=CLASS_LEN), parameter :: D5 = 'TM5d' !! 5d transition metal
  character(len=CLASS_LEN), parameter :: D6 = 'TM6d' !! 6d transition metal
  character(len=CLASS_LEN), parameter :: F4 = 'RE4f' !! 4f rare earth
  character(len=CLASS_LEN), parameter :: F5 = 'RE5f' !! 5f rare earth
  character(len=CLASS_LEN), parameter :: SP = 'sp  ' !! usual
  character(len=CLASS_LEN), parameter :: CT = 'cstm' !! custom
  integer, parameter :: Z_MIN =  -1 !! lower boundary of the periodic table
  integer, parameter :: Z_MAX = 121 !! upper boundary of the periodic table

  integer, parameter, public :: Z_INVALID = Z_MIN-1
  integer, parameter, public :: Z_MAXIMUM = Z_MAX
  integer, parameter, public :: Z_MINIMUM = Z_MIN
  real,    parameter, public :: NUCLEON_MASS = 1822.888479031408 !! one Dalton, approx. mass of a nucleon in atomic(Hartree) units


  ! electronegativity table taken from Handbook of Chemistry and Physics
  ! page 9-77: References:
  ! 1. Pauling, L., The Nature of the Chemical Bond, Third Edition, Cornell University Press, Ithaca, NY, 1960.
  ! 2. Allen, L. C., J. Am. Chem. Soc., 111, 9003, 1989.
  ! 3. Allred, A. L., J. Inorg. Nucl. Chem., 17, 215, 1961.\

    !============================================================================!
    !!!!       Z sym   name     e-negativity  class   weight   electronic configuration !!!!
    !============================================================================!
  type(element), protected, private :: edata(Z_MIN:Z_MAX) = (/ &
    element( -1.,'e ','Electron     ',UKEN,CT,1.00, .00054858,'1s -1 | 1.0'), & ! one electron
    element(  0.,'__','Vacuum       ',0.00,CT,1.00,  0.000000,'1s 0 | 0.2'), & ! nothing
    element(  1.,'H ','Hydrogen     ',2.20,R1,1.66,  1.007940,'1s* 1 2p | 0.9'), & ! 1s
    element(  2.,'He','Helium       ',NGEN,NG,2.51,  4.002602,'1s* 2 2p | 1.5'), & ! noble gas
    element(  3.,'Li','Lithium      ',0.98,R1,0.88,  6.941000,'2s 1 0 2p | 2.0'), & !
    element(  4.,'Be','Beryllium    ',1.57,R1,1.42,  9.012182,'2s* 2 2p | 1.5'), & !
    element(  5.,'B ','Boron        ',2.04,R1,1.50, 10.811000,'2s* 2 2p* 1 0 3d | 1.2'), & !
    element(  6.,'C ','Carbon       ',2.55,R1,1.71, 12.010700,'2s* 2 2p* 2 0 3d | 1.2'), & !
    element(  7.,'N ','Nitrogen     ',3.04,R1,1.91, 14.006740,'2s* 2 2p* 3 0 3d | 1.14 1.0 1.09'), & !
    element(  8.,'O ','Oxygen       ',3.44,R1,2.10, 15.999400,'2s* 2 2p* 3 1 3d | 1.3 1.13 1.17'), & !
    element(  9.,'F ','Fluorine     ',3.98,R1,2.28, 18.998404,'2s* 2 2p* 3 2 3d | 1.2'), & !
    element( 10.,'Ne','Neon         ',NGEN,NG,2.45, 20.179701,'2s* 2 2p* 2 3d | 1.8'), & !
    element( 11.,'Na','Sodium       ',0.93,SP,0.99, 22.989771,'3s* 1 0 2p 6 3p 3d | 2.27 2.3 2.34'), & !
    element( 12.,'Mg','Magnesium    ',1.31,SP,1.25, 24.305000,'2s 2 3s 2 2p 6 3p 3d | 2.06 2.05 1.96'), & !
    element( 13.,'Al','Aluminum     ',1.61,SP,1.22, 26.981539,'3s* 2 3p* 1 0 3d | 2.05'), & !
    element( 14.,'Si','Silicon      ',1.90,SP,1.41, 28.085501,'3s* 2 3p* 2 0 3d | 2.0'), & !
    element( 15.,'P ','Phosphorus   ',2.19,SP,1.61, 30.973761,'3s* 2 3p* 3 0 3d | 1.8'), & !
    element( 16.,'S ','Sulfur       ',2.58,SP,1.80, 32.066002,'3s* 2 3p* 3 1 3d | 1.84 1.85 1.7'), & !
    element( 17.,'Cl','Chlorine     ',3.16,SP,1.98, 35.452702,'3s* 2 3p* 3 2 3d | 1.5'), & !
    element( 18.,'Ar','Argon        ',NGEN,NG,2.14, 39.948002,'3s* 2 3p* 6 3d | 1.6'), & !
    element( 19.,'K ','Potassium    ',0.82,SP,1.07, 39.098301,'3s 2 4s 1 0 3p 6 4p 3d | 2.12 2.09 1.77'), & !
    element( 20.,'Ca','Calcium      ',1.00,SP,1.15, 40.077999,'3s 2 4s 2 3p 6 4p 3d* | 2.22 2.18 1.77'), & !
    element( 21.,'Sc','Scandium     ',1.36,D3,1.22, 44.955910,'3s 2 4s 2 3p 6 4p 3d* 1 0 | 2.32 2.42 2.26'), & !
    element( 22.,'Ti','Titanium     ',1.54,D3,1.28, 47.867001,'3s 2 4s 2 3p 6 4p 3d* 2 0 | 2.4 2.0'), & !
    element( 23.,'V ','Vanadium     ',1.63,D3,1.34, 50.941502,'4s* 2 4p* 3d* 3 0 | 2.5 2.4 2.0'), & !
    element( 24.,'Cr','Chromium     ',1.66,D3,1.38, 51.996101,'4s* 1 0 4p* 3p 6 3d 5 0 | 2.3 2.3 2.3'), & !
    element( 25.,'Mn','Manganese    ',1.55,D3,1.43, 54.938049,'3s 2 4s 2 3p 6 4p 3d* 5 0 | 2.41 2.42'), & !
    element( 26.,'Fe','Iron         ',1.83,D3,1.47, 55.845001,'4s* 2 4p* 3d* 5 1 | 2.2 2.0'), & !
    element( 27.,'Co','Cobalt       ',1.88,D3,1.50, 58.933201,'4s* 2 4p* 3d 5 2 | 2.0 2.1 2.0 V=p'), & !
    element( 28.,'Ni','Nickel       ',1.91,D3,1.53, 58.693401,'4s* 2 3p 6 4p 3d* 5 3 | 2.2 2.28 2.15'), & !
    element( 29.,'Cu','Copper       ',1.90,D3,1.51, 63.546001,'4s* 1 0 4p* 3d* 10 | 2.2 2.2 2.0'), & !
    element( 30.,'Zn','Zinc         ',1.65,D3,1.59, 65.389999,'4s* 2 4p* 3d* 10 | 2.43 2.4 2.23'), & !
    element( 31.,'Ga','Gallium      ',1.81,SP,1.29, 69.723000,'4s* 2 4p* 1 0 4d | 2.2'), & !
    element( 32.,'Ge','Germanium    ',2.01,SP,1.41, 72.610001,'4s* 2 4p* 2 0 4d | 1.9'), & !
    element( 33.,'As','Arsenic      ',2.18,SP,1.57, 74.921600,'4s* 2 4p* 3 0 4d | 2.0'), & !
    element( 34.,'Se','Selenium     ',2.55,SP,1.72, 78.959999,'4s* 2 4p* 3 1 4d | 1.6 1.9 1.6'), & !
    element( 35.,'Br','Bromine      ',2.96,SP,1.87, 79.903999,'4s* 2 4p* 3 2 4d | 2.1'), & !
    element( 36.,'Kr','Krypton      ',NGEN,NG,2.02, 83.800003,'4s* 2 4p* 6 4d | 2.2'), & !
    element( 37.,'Rb','Rubidium     ',0.82,SP,1.10, 85.467796,'4s 2 5s 1 4p* 6 4d | 2.6 2.4 2.3'), & !
    element( 38.,'Sr','Strontium    ',0.95,SP,1.16, 87.620003,'4s 2 5s 2 4p* 6 4d | 2.44 2.44 2.37'), & !
    element( 39.,'Y ','Yttrium      ',1.22,D4,1.23, 88.905853,'4s 2 5s 2 4p 6 5p 4d* 1 0 | 2.51 2.49 2.43'), & !
    element( 40.,'Zr','Zirconium    ',1.33,D4,1.30, 91.223999,'4s 2 5s 2 4p 6 5p 4d 2 0 | 2.5 2.52 2.35'), & !
    element( 41.,'Nb','Niobium      ',1.60,D4,1.37, 92.906380,'4s 2 5s 1 0 4p 6 5p 4d* 4 0 | 2.5 2.5 2.35'), & !
    element( 42.,'Mo','Molybdenum   ',2.16,D4,1.42, 95.940002,'4s 2 5s 1 0 4p 6 5p 4d 5 0 | 2.34 2.45'), & !
    element( 43.,'Tc','Technetium   ',2.10,D4,1.47, 98.000000,'5s* 2 5p* 4d* 5 0 | 2.0'), & !
    element( 44.,'Ru','Ruthenium    ',2.20,D4,1.50,101.070000,'4s 2 5s 1 0 4p 6 5p 4d 5 2 | 2.42 2.43 2.37'), & !
    element( 45.,'Rh','Rhodium      ',2.28,D4,1.53,102.905502,'5s* 1 0 4p 6 5p 4d 5 3 | 2.4 2.61 2.35'), & !
    element( 46.,'Pd','Palladium    ',2.20,D4,1.56,106.419998,'5s* 4p 6 5p 4d* 10 | 2.32 2.57 2.32'), & !
    element( 47.,'Ag','Silver       ',1.93,D4,1.56,107.868202,'5s* 1 0 4p 6 5p 4d* 10 | 2.43 2.51 2.23'), & !
    element( 48.,'Cd','Cadmium      ',1.69,D4,1.60,112.411003,'5s* 2 5p* 4d* 10 | 2.25 2.32 2.2'), & !
    element( 49.,'In','Indium       ',1.78,SP,1.31,114.818001,'5s* 2 5p* 1 0 4d* 10 | 2.24 2.35 2.17'), & !
    element( 50.,'Sn','Tin          ',1.96,SP,1.38,118.709999,'5s* 2 5p* 2 0 4d* 10 | 2.27 2.4 2.24'), & !
    element( 51.,'Sb','Antimony     ',2.05,SP,1.49,121.760002,'5s* 2 5p* 3 0 4d* 10 | 2.18 2.33 2.26'), & !
    element( 52.,'Te','Tellurium    ',2.10,SP,1.62,127.599998,'5s* 2 5p* 3 1 4d* 10 | 2.2'), & !
    element( 53.,'I ','Iodine       ',2.66,SP,1.74,126.904472,'5s* 2 5p* 3 2 5d | 2.2'), & !
    element( 54.,'Xe','Xenon        ',2.60,NG,1.87,131.289993,'5s* 2 5p* 6 5d | 2.27 2.4 2.24'), & !
    element( 55.,'Cs','Cesium       ',0.79,SP,1.10,132.905457,'5s 2 6s 1 0 5p 6 6p 5d | 2.2 2.0'), & !
    element( 56.,'Ba','Barium       ',0.89,SP,1.14,137.326996,'5s 2 6s 2 5p 6 6p 5d* | 2.2'), & !
    element( 57.,'La','Lanthanum    ',1.10,D5,1.21,138.905502,'5s 2 6s 2 5p* 6 5d* 1 0 | 2.3 2.0 1.9'), & !
    element( 58.,'Ce','Cerium       ',1.12,F4,1.22,140.115997,'6s* 2 6p* 5d* 1 0 4f 1 0 | 2.0'), & !
    element( 59.,'Pr','Praseodymium ',1.13,F4,1.23,140.907654,'6s* 2 6p* 5d* 1 0 4f 2 0 | 2.0'), & !
    element( 60.,'Nd','Neodymium    ',1.14,F4,1.24,144.240005,'6s* 2 6p* 5d* 1 0 4f 3 0 | 2.0'), & !
    element( 61.,'Pm','Promethium   ',UKEN,F4,1.25,145.000000,'6s* 2 6p* 5d* 1 0 4f 4 0 | 2.0'), & !
    element( 62.,'Sm','Samarium     ',1.17,F4,1.25,150.360001,'6s* 2 6p* 5d* 1 0 4f 5 0 | 2.0'), & !
    element( 63.,'Eu','Europium     ',UKEN,F4,1.26,151.964005,'6s* 2 6p* 5d* 1 0 4f 6 0 | 2.0'), & !
    element( 64.,'Gd','Gadolinium   ',1.20,F4,1.27,157.250000,'6s* 2 6p* 5d* 1 0 4f 7 0 | 2.0'), & !
    element( 65.,'Tb','Terbium      ',UKEN,F4,1.27,158.925339,'6s* 2 6p* 5d* 1 0 4f 7 1 | 2.0'), & !
    element( 66.,'Dy','Dysprosium   ',1.22,F4,1.27,162.500000,'6s* 2 6p* 5d* 1 0 4f 7 2 | 2.0'), & !
    element( 67.,'Ho','Holmium      ',1.23,F4,1.28,164.930313,'6s* 2 6p* 5d* 1 0 4f 7 3 | 2.0'), & !
    element( 68.,'Er','Erbium       ',1.24,F4,1.28,167.259995,'6s* 2 6p* 5d* 1 0 4f 7 4 | 2.0'), & !
    element( 69.,'Tm','Thulium      ',1.25,F4,1.28,168.934204,'6s* 2 6p* 5d* 1 0 4f 7 5 | 2.0'), & !
    element( 70.,'Yb','Ytterbium    ',UKEN,F4,1.28,173.039993,'6s* 2 6p* 5d* 1 0 4f 7 6 | 2.0'), & !
    element( 71.,'Lu','Lutetium     ',1.00,F4,1.28,174.966995,'6s* 2 6p* 5d* 1 0 4f 14 | 2.0'), & !
    element( 72.,'Hf','Hafnium      ',1.30,D5,1.36,178.490005,'5s 2 6s 2 5p 6 6p 5d* 2 0 | 2.64 2.47 2.52'), & !
    element( 73.,'Ta','Tantalum     ',1.50,D5,1.44,180.947906,'5s 2 6s 2 5p 6 6p 5d* 3 0 | 2.58 2.55 2.47'), & !
    element( 74.,'W ','Tungsten     ',1.70,D5,1.51,183.839996,'5s 2 6s 2 5p 6 6p 5d* 4 0 | 2.54 2.56 2.32'), & !
    element( 75.,'Re','Rhenium      ',1.90,D5,1.57,186.207001,'6s* 2 5p 6 6p 5d* 5 0 | 2.6 2.6 2.47'), & !
    element( 76.,'Os','Osmium       ',2.20,D5,1.63,190.229996,'6s* 2 5p 6 6p 5d 5 1 | 2.55 2.64 2.35'), & !
    element( 77.,'Ir','Iridium      ',2.20,D5,1.68,192.216995,'6s* 2 5p 6 6p 5d* 5 2 | 2.45 2.51 2.43'), & !
    element( 78.,'Pt','Platinum     ',2.20,D5,1.72,195.078003,'6s* 1 0 5p 6 6p 5d* 5 4 | 2.47 2.59 2.47'), & !
    element( 79.,'Au','Gold         ',2.40,D5,1.75,196.966553,'6s* 1 0 6p* 5d* 10 | 2.5'), & !
    element( 80.,'Hg','Mercury      ',1.90,D5,1.78,200.589996,'6s* 2 5p 6 6p 5d* 10 | 2.47 2.44 2.46'), & !
    element( 81.,'Tl','Thallium     ',1.80,SP,1.34,204.383301,'6s* 2 6p* 1 0 5d* 10 | 2.29 2.4 2.25'), & !
    element( 82.,'Pb','Lead         ',1.80,SP,1.39,207.199997,'6s* 2 6p* 2 0 5d* 10 | 2.38 2.41 2.3'), & !
    element( 83.,'Bi','Bismuth      ',1.90,SP,1.48,208.980377,'6s* 2 6p* 3 0 5d* 10 | 2.43 2.41 2.55'), & !
    element( 84.,'Po','Polonium     ',2.00,SP,1.58,209.000000,'6s* 2 6p* 3 1 | 2.0'), & !
    element( 85.,'At','Astatine     ',2.20,SP,1.69,210.000000,'6s* 2 6p* 3 2 | 2.0'), & !
    element( 86.,'Rn','Radon        ',NGEN,NG,1.80,222.000000,'6s* 2 6p* 6 6d | 2.3 2.29 2.31'), & !
    element( 87.,'Fr','Francium     ',0.70,SP,1.14,223.000000,'7s* 1 0 7p | 2.0'), & !
    element( 88.,'Ra','Radium       ',0.90,SP,1.17,226.000000,'7s* 2 7p | 2.0'), & !
    element( 89.,'Ac','Actinium     ',1.10,D6,1.23,227.000000,'7s* 2 7p* 6d* 1 0 | 2.0'), & !
    element( 90.,'Th','Thorium      ',1.30,F5,1.25,232.038101,'7s* 2 7p* 6d* 1 0 5f 1 0 | 2.0'), & !
    element( 91.,'Pa','Protactinium ',1.50,F5,1.28,231.035873,'7s* 2 7p* 6d* 1 0 5f 2 0 | 2.0'), & !
    element( 92.,'U ','Uranium      ',1.70,F5,1.29,238.028900,'7s* 2 7p* 6d* 1 0 5f 3 0 | 2.0'), & !
    element( 93.,'Np','Neptunium    ',1.30,F5,1.31,237.000000,'7s* 2 7p* 6d* 1 0 5f 4 0 | 2.0'), & !
    element( 94.,'Pu','Plutonium    ',1.30,F5,1.31,244.000000,'7s* 2 7p* 6d* 1 0 5f 5 0 | 2.0'), & !
    element( 95.,'Am','Americium    ',UKEN,F5,1.32,243.000000,'7s* 2 7p* 6d* 1 0 5f 6 0 | 2.0'), & !
    element( 96.,'Cm','Curium       ',UKEN,F5,1.33,247.000000,'7s* 2 7p* 6d* 1 0 5f 7 0 | 2.0'), & !
    element( 97.,'Bk','Berkelium    ',UKEN,F5,1.33,247.000000,'7s* 2 7p* 6d* 1 0 5f 7 1 | 2.0'), & !
    element( 98.,'Cf','Californium  ',UKEN,F5,1.33,251.000000,'7s* 2 7p* 6d* 1 0 5f 7 2 | 2.0'), & !
    element( 99.,'Es','Einsteinium  ',UKEN,F5,1.33,252.000000,'7s* 2 7p* 6d* 1 0 5f 7 3 | 2.0'), & !
    element(100.,'Fm','Fermium      ',UKEN,F5,1.33,257.000000,'7s* 2 7p* 6d* 1 0 5f 7 4 | 2.0'), & !
    element(101.,'Md','Mendelevium  ',UKEN,F5,1.32,258.000000,'7s* 2 7p* 6d* 1 0 5f 7 5 | 2.0'), & !
    element(102.,'No','Nobelium     ',UKEN,F5,1.31,259.000000,'7s* 2 7p* 6d* 1 0 5f 7 6 | 2.0'), & !
    element(103.,'Lr','Lawrencium   ',UKEN,F5,1.31,262.000000,'7s* 2 7p* 6d* 1 0 5f 14 | 2.0'), & !
    element(104.,'Rf','Rutherfordium',UKEN,D6,1.38,261.000000,'7s* 2 7p* 6d* 2 0 | 2.0'), & !
    element(105.,'Db','Dubnium      ',UKEN,D6,1.46,262.000000,'7s* 2 7p* 6d* 3 0 | 2.0'), & !
    element(106.,'Sg','Seaborgium   ',UKEN,D6,1.55,266.000000,'7s* 2 7p* 6d* 4 0 | 2.0'), & !
    element(107.,'Bh','Bohrium*     ',UKEN,D6,1.63,264.000000,'7s* 2 7p* 6d* 5 0 | 2.0'), & !
    element(108.,'Hs','Hassium*     ',UKEN,D6,1.71,269.000000,'7s* 2 7p* 6d* 5 1 | 2.0'), & !
    element(109.,'Mt','Meitnerium*  ',UKEN,D6,1.79,268.000000,'7s* 2 7p* 6d* 5 2 | 2.0'), & !
    element(110.,'Ds','Darmstadtium*',UKEN,D6,1.86,271.000000,'7s* 2 7p* 6d* 5 3 | 2.0'), & !
    element(111.,'Rg','Roentgenium* ',UKEN,D6,1.93,272.000000,'7s* 2 7p* 6d* 5 4 | 2.0'), & !
    element(112.,'Cn','Copernicium* ',UKEN,D6,1.99,277.000000,'7s* 2 7p* 6d* 10 | 2.0'), & !
    element(113.,'ut','Ununtrium*   ',UKEN,SP,1.34,280.000000,'7s* 2 7p* 1 0 | 2.0'), & !
    element(114.,'uq','Ununquadium* ',UKEN,SP,1.38,289.000000,'7s* 2 7p* 2 0 | 2.0'), & !
    element(115.,'up','Ununpentium* ',UKEN,SP,1.45,290.000000,'7s* 2 7p* 3 0 | 2.0'), & !
    element(116.,'uh','Ununhexium*  ',UKEN,SP,1.54,289.000000,'7s* 2 7p* 3 1 | 2.0'), & !
    element(117.,'us','Ununseptium**',UKEN,SP,1.63,290.000000,'7s* 2 7p* 3 2 | 2.0'), & !
    element(118.,'uo','Ununoctium** ',UKEN,NG,1.70,293.000000,'7s* 2 7p* 6 | 2.0'), & !
    element(119.,'un','Ununnonium** ',UKEN,NG,1.70,296.000000,'8s* 1 | 2.0'), & !
    element(120.,'ud','Unvigintium**',UKEN,NG,1.70,300.000000,'8s* 2 | 2.0'), & !
    element(121.,'++','[Costum]     ',UKEN,SP,1.33,199.00E+19,'not configured | 1.0') /) ! special

    character, parameter, private :: ELLCHAR(-1:7) = (/'?','s','p','d','f','g','h','i','j'/)
    character, parameter, private :: ENNCHAR( 0:9) = (/'?','1','2','3','4','5','6','7','8','9'/)
    integer,   parameter, private :: ELL_INVALID = -1

#ifdef EXTENDED
!+ extended

    !!  autogenerated code !!
    integer(kind=8), parameter, private :: iPZ81_LEVELS(1:23,-1:121) = reshape( (/ &
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! e
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! __
     233664,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! H
     570227,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! He
     1877747,105604,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Li
     3856243,206031,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Be
     6565784,345065,136716,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! B
     9952270,501403,199184,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! C
     14020862,677034,266135,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! N
     18774798,872910,338038,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! O
     24216550,1089501,415069,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! F
     30348120,1327089,497289,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Ne
     37782031,2069588,1058824,103588,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Na
     46062689,2913638,1716716,175927,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Mg
     55282012,3950304,2561769,287894,102426,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Al
     65357525,5098375,3513241,399986,153188,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Si
     76294351,6362891,4575831,515265,205893,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! P
     88095948,7746545,5751848,635181,261362,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! S
     100765055,9250908,7042456,760489,319913,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Cl
     114304221,10877082,8448329,891655,381702,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Ar
     129046737,12944767,10290377,1292104,691587,0,088905,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! K
     144719594,15181824,12295734,1720626,1028070,0,142122,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Ca
     161152063,17380996,14259955,2010397,1233311,125835,157933,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Sc
     178457798,19678343,16316065,2288061,1425306,163990,169039,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Ti
     196651885,22089498,18478817,2566096,1615291,197706,178332,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! V
     215741827,24620743,20753747,2848848,1807021,228616,186658,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Cr
     235733268,27275807,23143865,3138525,2002321,257504,194384,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Mn
     256631221,30057378,25651134,3436479,2202259,284822,201708,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Fe
     278440485,32967634,28276988,3743646,2407532,310858,208745,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Co
     301165830,36008484,31022566,4060735,2618637,335810,215572,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Ni
     324620866,38969244,33678592,4194980,2647146,195688,178789,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Cu
     349384213,42488917,36876605,4726873,3059775,383002,228789,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Zn
     375236041,46306450,40358557,5417848,3625354,712889,337088,100558,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Ga
     402080630,50326432,44027908,6164080,4240116,1086055,439115,148911,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Ge
     429922896,54548636,47883675,6963906,4902837,1502805,540312,196514,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! As
     458766900,58972183,51924123,7815303,5611710,1961927,642582,244779,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Se
     488617117,63596687,56147926,8716839,6365370,2462240,746803,294255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Br
     519478575,68422312,60554234,9667632,7162900,3002820,853492,345213,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, & ! Kr
     551610626,73699561,65393072,10913815,8250232,3829065,1174036,588453,0,0,086424,0,0,0,0,0,0,0,0,0,0,0,0, & ! Rb
     584788991,79200368,70435044,12226444,9398315,4712240,1503315,839761,0,0,133884,0,0,0,0,0,0,0,0,0,0,0,0, & ! Sr
     618938945,84836828,75591700,13518346,10519778,5564317,1763544,1026763,097193,0,155577,0,0,0,0,0,0,0,0,0,0,0,0, & ! Y
     654106106,90653377,80905780,14833384,11658318,6429132,2003255,1194343,137302,0,168860,0,0,0,0,0,0,0,0,0,0,0,0, & ! Zr
     690309990,96664887,86390713,16185184,12827293,7319835,2235977,1354766,175576,0,178728,0,0,0,0,0,0,0,0,0,0,0,0, & ! Nb
     727562170,102877682,92051358,17578734,14031384,8240858,2466418,1512105,213097,0,186719,0,0,0,0,0,0,0,0,0,0,0,0, & ! Mo
     765872385,109295927,97890360,19016773,15272996,9194339,2696958,1668322,250317,0,193529,0,0,0,0,0,0,0,0,0,0,0,0, & ! Tc
     805249848,115923001,103909518,20501166,16553629,10181509,2929052,1824558,287462,0,199535,0,0,0,0,0,0,0,0,0,0,0,0, & ! Ru
     845703678,122761950,110110226,22033356,17874338,11203155,3163696,1981554,324658,0,204965,0,0,0,0,0,0,0,0,0,0,0,0, & ! Rh
     887243094,129815685,116493673,23614564,19235935,12259811,3401634,2139831,361979,0,209968,0,0,0,0,0,0,0,0,0,0,0,0, & ! Pd
     929721626,136922652,122897109,25084391,20477572,13189534,3494042,2155975,281564,0,173442,0,0,0,0,0,0,0,0,0,0,0,0, & ! Ag
     973616598,144579012,129812992,26928341,22084336,14479600,3889645,2461688,437158,0,219074,0,0,0,0,0,0,0,0,0,0,0,0, & ! Cd
     1018733932,152567570,137023272,28931356,23840650,15912840,4390034,2868027,687524,0,311790,099251,0,0,0,0,0,0,0,0,0,0,0, & ! In
     1065001553,160810870,144448385,31012633,25665229,17407975,4911578,3291105,951675,0,397404,142324,0,0,0,0,0,0,0,0,0,0,0, & ! Sn
     1112432615,169314232,152091549,33175191,27560567,18967257,5456922,3733742,1233007,0,480996,183693,0,0,0,0,0,0,0,0,0,0,0, & ! Sb
     1161038430,178080946,159953846,35419970,29527057,20590822,6026599,4196516,1532290,0,564487,224797,0,0,0,0,0,0,0,0,0,0,0, & ! Te
     1210830149,187113915,168035866,37747462,31564610,22278321,6620673,4679452,1849573,0,648785,266227,0,0,0,0,0,0,0,0,0,0,0, & ! I
     1261819231,196416098,176338142,40158145,33673099,24029351,7239159,5182476,2184725,0,734417,308284,0,0,0,0,0,0,0,0,0,0,0, & ! Xe
     1314214508,206185540,185056473,42846322,36046224,26037363,8073616,5896710,2727764,0,987409,499075,0,0,0,081082,0,0,0,0,0,0,0, & ! Cs
     1367841930,216239936,194005786,45627246,38498554,28116668,8939203,6637247,3294308,0,1241854,690748,0,0,0,122970,0,0,0,0,0,0,0, & ! Ba
     1422647232,226511708,203115966,48431590,40960068,30196582,9767121,7335185,3815459,0,1435509,825833,117790,0,0,140217,0,0,0,0,0,0,0, & ! La
     1478421756,236757050,212144905,50964643,43136481,31987331,10297884,7740275,4058353,206051,1496434,856124,116907,0,0,142731,0,0,0,0,0,0,0, & ! Ce
     1535429124,247254378,221363739,53544891,45344489,33800991,10825695,8138552,4292433,236490,1554266,883670,115015,0,0,145117,0,0,0,0,0,0,0, & ! Pr
     1593687848,258012328,230777817,56178865,47589784,35642796,11355461,8534490,4521602,261624,1610517,909562,112485,0,0,147462,0,0,0,0,0,0,0, & ! Nd
     1653215331,269037856,240390697,58870932,49875865,37515819,11890129,8930680,4748060,282605,1666013,934381,109510,0,0,149808,0,0,0,0,0,0,0, & ! Pm
     1714028764,280337224,250205104,61624445,52205181,39422095,12431728,9328820,4973209,300174,1721272,958479,106205,0,0,152179,0,0,0,0,0,0,0, & ! Sm
     1776145508,291916393,260223317,64442212,54579601,41363083,12981787,9730125,5198022,314843,1776655,982091,102650,0,0,154589,0,0,0,0,0,0,0, & ! Eu
     1839583285,303781228,270447351,67326729,57000635,43339886,13541534,10135513,5423210,326992,1832432,1005388,098906,0,0,157052,0,0,0,0,0,0,0, & ! Gd
     1904360298,315937603,280879061,70280304,59469566,45353373,14112010,10545714,5649318,336912,1888815,1028494,095016,0,0,159579,0,0,0,0,0,0,0, & ! Tb
     1970495319,328391474,291520200,73305135,61987516,47404253,14694132,10961330,5876780,344836,1945982,1051512,091019,0,0,162180,0,0,0,0,0,0,0, & ! Dy
     2038007747,341148927,302372454,76403359,64555500,49493120,15288735,11382871,6105949,350956,2004087,1074523,086947,0,0,164863,0,0,0,0,0,0,0, & ! Ho
     2106917669,354216210,313437473,79577090,67174452,51620483,15896599,11810786,6337122,355432,2063266,1097597,082828,0,0,167637,0,0,0,0,0,0,0, & ! Er
     2177245908,367599766,324716878,82828436,69845249,53786786,16518467,12245470,6570552,358401,2123648,1120794,078686,0,0,170513,0,0,0,0,0,0,0, & ! Tm
     2249014071,381306253,336212282,86159524,72568724,55992422,17155059,12687287,6806460,359982,2185350,1144168,074545,0,0,173499,0,0,0,0,0,0,0, & ! Yb
     2322244597,395342567,347925291,89572511,75345680,58237748,17807084,13136569,7045042,360281,2248488,1167767,070425,0,0,176606,0,0,0,0,0,0,0, & ! Lu
     2397239469,410015432,360154074,93402709,78509417,60852189,18792610,13904288,7587442,625893,2468349,1312267,105544,0,0,193596,0,0,0,0,0,0,0, & ! Hf
     2473771173,425062627,372633182,97355129,81763966,63542169,19824212,14707501,8158466,916151,2689640,1453718,139090,0,0,206541,0,0,0,0,0,0,0, & ! Ta
     2551863378,440489916,385362365,101429344,85107357,66305354,20899795,15543747,8755846,1229795,2914033,1594277,172035,0,0,217225,0,0,0,0,0,0,0, & ! W
     2631540887,456303600,398341585,105625471,88538077,69139827,22017816,16411059,9377714,1565485,3142302,1734908,204774,0,0,226463,0,0,0,0,0,0,0, & ! Re
     2712829857,472510635,411571129,109944156,92055057,72044092,23177261,17307955,10022632,1922059,3374947,1876159,237505,0,0,234708,0,0,0,0,0,0,0, & ! Os
     2795757838,489118607,425051567,114386487,95657583,75016982,24377540,18233336,10689500,2298552,3612378,2018391,270338,0,0,242240,0,0,0,0,0,0,0, & ! Ir
     2880353794,506135693,438783693,118953919,99345210,78057584,25618387,19186391,11377471,2694168,3854961,2161871,303340,0,0,249249,0,0,0,0,0,0,0, & ! Pt
     2966648132,523570635,452768481,123648216,103117700,81165175,26899798,20166528,12085890,3108245,4103052,2306808,336553,0,0,255868,0,0,0,0,0,0,0, & ! Au
     3054672746,541432731,467007046,128471410,106974979,84339178,28221973,21173321,12814244,3540230,4356999,2453379,370002,0,0,262195,0,0,0,0,0,0,0, & ! Hg
     3144675038,559949888,481718514,133642208,111133507,87796056,29800560,22421648,13777292,4204376,4825000,2802240,573851,0,0,361250,094734,0,0,0,0,0,0, & ! Tl
     3236488745,578928455,496700275,138959676,115390014,91331740,31432754,23707961,14771290,4897147,5307413,3158827,782249,0,0,452864,136323,0,0,0,0,0,0, & ! Pb
     3330153478,598382193,511956518,144429269,119747475,94948660,33121807,25034734,15798568,5620845,5807300,3526279,998929,0,0,542419,175452,0,0,0,0,0,0, & ! Bi
     3425708296,618323155,527489194,150054342,124206633,98647001,34868805,26402228,16859232,6375543,6325482,3905352,1224863,0,0,632000,213755,0,0,0,0,0,0, & ! Po
     3523193523,638763408,543299699,155837846,128767675,102426379,36674344,27810168,17952846,7160755,6862223,4296157,1460209,0,0,722608,251889,0,0,0,0,0,0, & ! At
     3622651368,659715558,559389363,161782827,133430729,106286334,38539015,29258224,19078908,7975927,7417711,4698667,1704903,0,0,814844,290187,0,0,0,0,0,0, & ! Rn
     3724292406,681357983,575924757,168057039,138360466,110390927,40627570,30910117,20400899,8984421,8154866,5275102,2119587,0,0,1053789,452803,0,0,0,0,085262,0, & ! Fr
     3828001771,703543789,592746307,174503155,143396283,114578962,42780050,32604854,21757654,10025036,8913469,5865024,2544633,0,0,1292753,613584,0,0,0,0,125703,0, & ! Ra
     3933796134,726253576,609821273,181090919,148504468,118815935,44963594,34308479,23114984,11063539,9660095,6434687,2946199,0,0,1500057,743975,087260,0,0,0,150216,0, & ! Ac
     4041599362,749367962,627016825,187677342,153538421,122955451,47034369,35876436,24328253,11953993,10253818,6846356,3196002,051690,0,1600591,791578,091681,0,0,0,155532,0, & ! Th
     4151587048,773030855,644461192,194402471,158634247,127132326,49128904,37443884,25532439,12832111,10831454,7234938,3422712,091608,0,1686792,827691,092030,0,0,0,158870,0, & ! Pa
     4263828643,797272378,662168433,201284100,163805596,131359470,51261629,39023930,26740421,13710721,11406481,7613236,3638176,127973,0,1767012,858683,090868,0,0,0,161771,0, & ! U
     4378389335,822115861,680144830,208332039,169057877,135641564,53438853,40621493,27956881,14594417,11984196,7985957,3846563,161962,0,1844030,886521,088851,0,0,0,164549,0, & ! Np
     4495335884,847583735,698394687,215554247,174394363,139981150,55664848,42239369,29184372,15485648,12567775,8355697,4050083,194126,0,1919298,912172,086274,0,0,0,167321,0, & ! Pu
     4614737996,873698789,716921480,222958081,179817427,144379857,57943072,43879443,30424527,16385947,13159497,8724140,4250116,224783,0,1993736,936210,083303,0,0,0,170143,0, & ! Am
     4736669029,900484674,735728264,230550755,185328966,148838826,60276606,45543124,31678498,17296355,13761184,9092492,4447608,254138,0,2067998,959016,080044,0,0,0,173049,0, & ! Cm
     4861206505,927966201,754817853,238339566,190930601,153358911,62668360,47231535,32947142,18217625,14374395,9461667,4643248,282331,0,2142587,980858,076573,0,0,0,176063,0, & ! Bk
     4988432585,956169563,774192915,246332029,196623781,157940775,65121184,48945619,34231128,19150320,15000540,9832396,4837562,309465,0,2217915,1001936,072949,0,0,0,179204,0, & ! Cf
     5118434544,985122531,793856027,254535970,202409838,162584953,67637938,50686194,35530996,20094872,15640940,10205278,5030964,335619,0,2294336,1022406,069218,0,0,0,182491,0, & ! Es
     5251305279,1014854639,813809706,262959604,208290028,167291887,70221540,52453993,36847194,21051623,16296871,10580824,5223790,360853,0,2372171,1042392,065419,0,0,0,185939,0, & ! Fm
     5387143868,1045397391,834056432,271611603,214265554,172061948,72875006,54249687,38180099,22020844,16969592,10959478,5416317,385217,0,2451716,1061996,061588,0,0,0,189566,0, & ! Md
     5526056176,1076784466,854598659,280501159,220337578,176895453,75601478,56073900,39530036,23002756,17660369,11341635,5608780,408753,0,2533256,1081305,057754,0,0,0,193392,0, & ! No
     5668155548,1109051958,875438825,289638057,226507240,181792678,78404255,57927223,40897290,23997537,18370495,11727648,5801380,431495,0,2617073,1100393,053948,0,0,0,197435,0, & ! Lr
     5813789028,1142474210,896814729,299282188,233025284,187002902,81534139,60056866,42528652,25253525,19343316,12354456,6221073,643242,0,2862174,1233805,085283,0,0,0,222481,0, & ! Rf
     5962875092,1176871745,918507893,309212117,239660077,192294103,84763405,62232330,44193328,26538582,20351685,12997650,6651186,862827,0,3110012,1362210,114260,0,0,0,242984,0, & ! Db
     6115555699,1212290572,940521744,319440628,246413495,197667267,88096765,64454893,45892265,27853549,21397839,13658308,7092873,1091954,0,3363681,1488811,142183,0,0,0,261199,0, & ! Sg
     6271982868,1248779211,962858533,329980335,253286316,203122258,91538121,66724733,47625304,29198166,22483024,14336396,7546109,1330881,0,3624633,1614927,169550,0,0,0,278115,0, & ! Bh
     6432320923,1286390054,985520252,340844674,260279107,208658710,95091483,69041818,49392071,30571957,23608397,15031675,8010630,1579485,0,3893847,1741254,196599,0,0,0,294288,0, & ! Hs
     6596748220,1325180075,1008508847,352048232,267392420,214276222,98761210,71406104,51192172,31974433,24775237,15743900,8486140,1837535,0,4172148,1868224,223458,0,0,0,310080,0, & ! Mt
     6765458967,1365211474,1031826268,363606933,274626843,219974409,102552098,73817586,53025246,33405134,25985009,16472872,8972367,2104781,0,4460318,1996134,250204,0,0,0,325759,0, & ! Ds
     6938665272,1406552371,1055474476,375538220,281983002,225752911,106469446,76276305,54890969,34863640,27239385,17218438,9469075,2380974,0,4759146,2125204,276880,0,0,0,341536,0, & ! Rg
     7116599551,1449277602,1079455432,387861244,289461564,231611386,110519102,78782343,56789054,36349568,28540259,17980493,9976060,2665884,0,5069459,2255608,303514,0,0,0,357594,0, & ! Cn
     7299692519,1493647262,1103948737,400774021,297240063,237726617,114883943,81512132,58895589,38038868,30065598,18934613,10668678,3134159,0,5565684,2554216,469539,0,0,0,476601,086754, & ! ut
     7488055090,1539579934,1128783598,414127466,305146859,243925774,119398889,84293574,61038059,39758974,31645548,19908469,11374401,3613532,0,6077067,2854119,633775,0,0,0,589607,126462, & ! uq
     7682003551,1587180724,1153965606,427951119,313186390,250212239,124075586,87130512,63219917,41513253,33286440,20905664,12096688,4107460,0,6608310,3159371,800734,0,0,0,702554,163071, & ! up
     7881886754,1636563710,1179497525,442274671,321360332,256586622,128923824,90024049,65441871,43302325,34992187,21927081,12836284,4616674,0,7161507,3471202,971817,0,0,0,817950,198444, & ! uh
     8088093945,1687855851,1205381189,457130370,329669520,263048681,133953612,92974477,67703812,45125994,36766259,22972811,13593137,5141106,0,7738080,3789983,1147423,0,0,0,937150,233310, & ! us
     8301062584,1741200011,1231618086,472554211,338114547,269597927,139175957,95981874,70005416,46983852,38612345,24042752,14367003,5680490,0,8339394,4115839,1327648,0,0,0,1061120,268034, & ! uo
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,  & !
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,  & !
     0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 /), (/23,123/) ) !! -1E-6*integer_value is the energy eigenvalue in Hartree

!- extended
#endif


  contains

  real function neutral_level_energy( Z, inl ) result( e )
    real   , intent(in) :: Z
    integer, intent(in) :: inl
#ifndef EXTENDED
    integer, parameter :: enn(1:23) = (/1,2,2,3,3,3,4,4,4,4,5,5,5,5,5,6,6,6,6,6,6,7,7/)
    e = -0.5 * ( Z / enn(inl) )**2 ! hydrogen energy level in Hartree units
#else
    integer :: iZ
    e = 0. ! result for early return
    iZ = nint( Z )
    if( inl < 1 .or. inl > 23 ) return ! 0. ! highest inl is 23 (=='7p')
    selectcase( iZ )
    case( 1:118 )
      e = -1E-6 * iPZ81_LEVELS( inl, iZ )

#define ALLOW_FRACTIONAL_Z
#ifdef ALLOW_FRACTIONAL_Z
      ! linear interpolation
      if( Z > real(iZ) ) then
        e = -1E-6 * iPZ81_LEVELS( inl, iZ ) -1E-6 * ( Z-iZ )*( iPZ81_LEVELS( inl, iZ+1 ) - iPZ81_LEVELS( inl, iZ ) )
      elseif( Z < real(iZ) ) then
        e = -1E-6 * iPZ81_LEVELS( inl, iZ ) -1E-6 * ( iZ-Z )*( iPZ81_LEVELS( inl, iZ-1 ) - iPZ81_LEVELS( inl, iZ ) )
      endif ! Z is integer
#endif
    case default ; return ! 0.
    endselect ! iZ
#endif
  endfunction ! neutral_level_energy


  !! setter function that alters the electronic configuration
  !! string of an element in the module array edata.
  !! If the first word in the line is supposed to be a keyword,
  !! the beginning of the line is compared to that keyword.
  status_t function customize_element( str, keyword ) result( ios )
  use configuration, only: WARNING
    character(len=*), intent(in) :: str
    character(len=3), intent(in), optional :: keyword ! 1st 3 letters only

    character(len=*), parameter :: fun = ' customize_element: '
    character(len=3) :: kw, sm ! keyword, symbol
    integer :: idx, iZ, lsm

    ios = 0 ! success
cDBG  if(o>0) write(o,'(9A)') sym, fun, 'start with "', trim(str), '".'

    if( present( keyword ) ) then 
      read( unit=str, fmt=*, iostat=ios ) kw, sm ! keyword, symbol
      if( kw /= keyword(1:3) ) then
        if(o>0) write(o,'(9A)') sym, fun, WARNING(0), &
          'first word in the line should be the keyword "',trim(keyword),'", but found "',trim(kw),'".'
      endif ! keyword differs
    else
      read( unit=str, fmt=*, iostat=ios ) sm ! symbol
    endif

    if( ios /= 0 ) then
cDBG  if(o>0) write(o,'(9A)') sym, fun, 'cannot find specifications in "', trim(str), '".'
      return
    endif ! ios

    iZ = atomicnumber_by_symbol( sm )
    if( iZ == Z_INVALID ) then
      ios = Z_INVALID
      if(o>0) write(o,'(9A)') sym, fun, 'cannot identify "', trim(sm), '" as an element.'
      return
    endif ! ios

    lsm = len_trim(sm) ! length of the symbol or number
!     idx = index( str, trim(sm), back=.true. ) ! index, where in str the configuration starts
    idx = index( str, trim(sm) ) ! index, where in str the configuration starts, better start from the front,
    ! using the atomic numbers could lead to missunderstandings. watch out that the keyword is not a chem. symbol.
cDBG  if(o>0) write(o,'(5A,9(I0,A))') sym, fun, 'found "', trim(sm), '" in string with len=', lsm, ' at ', idx
    idx = idx+lsm
cDBG  if( str(idx:idx) /= ' ' ) stop 'tELEMENT customize_element: fatal error parsing string!'
    idx = idx+1
cDBG  if(o>0) write(o,'(3A,I0,9A)') sym, fun, 'input string(', idx, ':) = "', trim(str(idx:)), '".'

    ! change edata
cDBG  if(o>0) write(o,'(3A,I0,9A)') sym, fun, 'change electronic configuration for Z = ', iZ, ' to "', trim(str(idx:)), '".'
    edata(iZ)%config = adjustl(str(idx:))

  endfunction ! customize_element

  !! returns the element_symbol from PSE with buffered input
  character(len=2) function symbol_i( iZ ) result( s )
    integer, intent(in) :: iZ !! atomic number

    character(len=*), parameter :: TOO_SMALL = '<m', TOO_LARGE = '>M'
    selectcase( iZ )
    case( :Z_MIN-1 ) ; s = TOO_SMALL
      if(o>0) write(o,'(A,9(A,I0))') sym,': atomic number < ',Z_MIN,', no element with Z = ',iZ
    case( Z_MAX+1: ) ; s = TOO_LARGE
      if(o>0) write(o,'(A,9(A,I0))') sym,': atomic number > ',Z_MAX,', symbol for Z = ',iZ,' not implemented'
    case default     ; s = edata(iZ)%sym
    endselect ! iZ
  endfunction ! symbol

  
  character(len=2) function symbol_e( e ) result( s )
    type(element), intent(in)       :: e !! element
    s = e%sym
  endfunction ! symbol
  
  
  !! returns the element_name from PSE with buffered input
  character(len=16) function element_name( iZ ) result( s )
    integer, intent(in) :: iZ !! atomic number

    character(len=*), parameter :: TOO_SMALL = '<m', TOO_LARGE = '>M'
    selectcase( iZ )
    case( :Z_MIN-1 ) ; s = TOO_SMALL
      if(o>0) write(o,'(A,9(A,I0))') sym,':element_name: atomic number < ',Z_MIN,', no element with Z = ',iZ
    case( Z_MAX+1: ) ; s = TOO_LARGE
      if(o>0) write(o,'(A,9(A,I0))') sym,':element_name: atomic number > ',Z_MAX,', symbol for Z = ',iZ,' not implemented'
    case default     ; s = edata(iZ)%name
    endselect ! iZ
  endfunction ! element_name
  

  !! retrieves the atomic number from the element symbol
  integer function atomicnumber_by_symbol( symbol_or_number ) result( Z )
  use configuration, only: WARNING
    character(len=*), intent(in) :: symbol_or_number

    character(len=*), parameter :: fun = ' atomicnumber_by_symbol: '
    character(len=3) :: s
    status_t :: ios

    Z = Z_INVALID ! not found
    s = adjustl( symbol_or_number )
    if( s  == '' ) then
      if(o>0) write(o,'(9A)') sym, fun, WARNING(0), 'received empty string.'
      return ! Z_INVALID
    endif ! s == ...

    ! direct reading of the atomic number
    Z = Z_INVALID ! not found
    read( unit=s, fmt=*, iostat=ios ) Z
    if( ios == 0 .and. Z >= Z_MIN .and. Z <= Z_MAX ) then
cDBG  if(o>0) write(o,'(3A,9(I0,A))') sym, fun, 'found element Z = ', Z, ' in string "', trim(s), '".'
      return
    endif ! ios == 0 .and. Z >= Z_MIN .and. Z <= Z_MAX

    ! search the symbol in the list edata
    Z = Z_MIN
    do while( Z <= Z_MAX )
      if( s(1:2) == edata( Z )%sym ) then
cDBG    if(o>0) write(o,'(5A,9(I0,A))') sym, fun, "found element '", s(1:2), "' at Z = ", Z
        return
      endif ! s == element_symbol( Z )
      Z = Z+1
    enddo ! Z < Z_MAX

    Z = Z_INVALID ! not found
    if(o>0) write(o,'(9A)') sym, fun, WARNING(0), "symbol '", trim(s), "' not found in PSE."

  endfunction ! atomicnumber_by_symbol


  type(element) function element_by_symbol_i( iZ ) result( e )
    integer, intent(in) :: iZ

    selectcase( iZ )
    case(     1:Z_MAX-1 ) ; e = edata(iZ) ! no warning
    case( Z_MIN,0,Z_MAX ) ; e = edata(iZ) 
      if(u>0) write(u,'(2A,I0)') sym,' element_by_symbol: special element Z = ',iZ
    case( Z_MAX+1: )      ; stop 'tELEMENT Z > Z_MAX'
    case( Z_INVALID )     ; stop 'tELEMENT invalid element'
    case default          ; stop 'tELEMENT Z < Z_MIN'
    endselect ! iZ
  endfunction ! element_by_symbol


  type(element) function element_by_symbol_s( symbol_or_number ) result( e )
    character(len=*), intent(in) :: symbol_or_number
    e = element_by_symbol_i( atomicnumber_by_symbol( symbol_or_number ) )
  endfunction ! element_by_symbol


  !! 's', 'p', 'd', 'f' ==> 0, 1, 2, 3
  integer function char2ell( lc ) result( ell )
  use configuration, only: WARNING
    character, intent(in) :: lc

    selectcase( lc )
    case( 's', 'S' ) ; ell = 0
    case( 'p', 'P' ) ; ell = 1
    case( 'd', 'D' ) ; ell = 2
    case( 'f', 'F' ) ; ell = 3
    case( 'g', 'G' ) ; ell = 4
    case( 'h', 'H', 'i', 'I' ) ; ell = ELL_INVALID
      if(o>0) write(o,'(9A)') sym,' char2ell: ', WARNING(0), 'ell > 4 not supported.'
    case default     ; ell = ELL_INVALID
    endselect ! lc
  endfunction ! char2ell

  !! '1', '2', '3' ==> 1, 2, 3
  integer function char2enn( nc ) result( enn )
    character, intent(in) :: nc

    selectcase( nc )
    case( '1','2','3','4','5','6','7','8','9' ) ; enn = ichar(nc)-ichar('0')
    case default ; enn = 0 ! invalid
    endselect ! nc
  endfunction ! char2enn

  status_t function init( ) result( ist )
    ist = 0
  endfunction ! init



  character(len=ECONF_LEN+4) function element2string( e ) result( str )
    type(element), intent(in) :: e
    status_t :: ios
    write(unit=str,fmt='(9A)',IOstat=ios) e%sym, '  ', trim(adjustl(e%config))
  endfunction ! element2string

  character(len=ECONF_LEN+16) function show_electronic_configuration( symbol ) result( str )
  use configuration, only: KeyWord, I_KeyWord_ELEM
    character(len=*), intent(in) :: symbol
    type(element) :: e
    status_t :: ios
    e = element_by_symbol( symbol )
    write(unit=str,fmt='(9A)',iostat=ios) trim(KeyWord(I_KeyWord_ELEM)), '  ', trim(to_string(e))
  endfunction ! show_electronic_configuration

#ifdef EXTENDED
!+ extended

  status_t function test( ) result( ios )
    integer :: spin, iocc(32), iz, i, n, m, l, j2, m2, s, k
    character(len=*), parameter :: ELLCHAR = 'spdfghijk'
    integer, parameter :: Width = 2
    character(len=40*Width) :: line
    do spin = 1, 0, -1 ! spin
      if( spin > 0 ) then ; write(*,'(/,A)') '# including spin'
      else                ; write(*,'(/,A)') '# no spin' ; endif
      write(*,'(9A)')  '# according to Aco Z. Muradjan '
      write(*,'(9A)')  '   nl    j    occ  index'
      iocc = 0
      iz = 0
      i = 0
      do m = 0, 7
        n = (m+1)/2
        do l = m/2, 0, -1
          n = n+1
          do j2 = 2*l+spin, max(0,2*l-spin), -2
            i = i+1
            write(*,'(I4,A,F6.1,I4,I9)') n, ELLCHAR(l+1:l+1), j2*.5, (2-spin)*(j2+1), i
            do m2 = -j2, j2, 2
              do s = 1, (2-spin)
                iZ = iZ+1
                iocc(i) = iocc(i)+1
!               write(*,'(I4,A,99I3)') iZ, ' occupation', iocc(1:i)
              enddo ! s
            enddo ! m2
          enddo ! j2
        enddo ! l
      enddo ! m


      if( spin > 0 ) cycle
      write(*,'(/,A)') '# table of elements according to Aco Z. Muradjan'
      iz = 0 ! init element index
      i = 0 ! init shell index
      do m = 0, 7
        n = (m+1)/2
        do l = m/2, 0, -1
          n = n+1
          do j2 = 2*l+spin, max(0,2*l-spin), -2
            i = i+1 ! next shell
            line = '' ! init clear
            k = Width * ( 32 - (2-spin)*(l+1)**2 )
            write(unit=line(34*Width:),fmt='(I1,A1)',iostat=ios) n, ELLCHAR(l+1:l+1)
            do m2 = -j2, j2, 2
              do s = 1, (2-spin)
                iZ = iZ+1 ! next element
                k = k+Width ! forward curser in line
                line(k:k+1) = symbol( iZ ) ! get chemical symbol
              enddo ! s
            enddo ! m2
            write(*,'(A)',iostat=ios) trim(line)
          enddo ! j2
        enddo ! l
      enddo ! m

      write(*,'(A)') ! empty line
    enddo ! spin
  endfunction ! test


!   !! parser for the configuration string
!   !! ncmx for predefined core:
!   !!
!   !! rare gases        [frozen d]        [frozen f]
!   !! __ '    '   0
!   !! He '1   '   2
!   !! Ne '22  '  10
!   !! Ar '33  '  18     3d '333 '  28
!   !! Kr '443 '  36     4d '444 '  46
!   !! Xe '554 '  54     5d '5554'  78     4f '5544'  68
!   !! Rn '6654'  86     6d '6665' 110     6d '6655' 100
!   !! uo '7765' 118
!   !!
!   !!  1s
!   !!  2s 2p
!   !!  3s 3p 3d
!   !!  4s 4p 4d 4f
!   !!  5s 5p 5d 5f
!   !!  6s 6p 6d
!   !!  7s 7p
!   !!  8s
!   !!

!- extended
#endif

endmodule ! type_element
